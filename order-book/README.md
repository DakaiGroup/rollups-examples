# Cartesi Order Book

Cartesi Order Book is an order book implementation for decentralized exchanges created in the Cartesi environment.
The application creates and runs an SQLite database internally which holds the products and orders data of the order book. You can send inputs with predefined structures to interact with the database and you get the results back as a notice. The available inputs are listed under [Example inputs](#example-inputs).

Currently the following actions are supported:

- Create new orders
- Delete orders by user
- Query orders and market data
- Query supported products
- Add new products

## Building the environment

To run the Cartesi Order Book example, clone the repository then, build the back-end for Cartesi Order Book:

```shell
$ cd order-book
$ make machine
```

## Running the environment

In order to start the containers in production mode, simply run:

```shell
$ docker-compose up --build
```

_Note:_ If you decide to use [Docker Compose V2](https://docs.docker.com/compose/cli-command/), make sure you set the [compatibility flag](https://docs.docker.com/compose/cli-command-compatibility/) when executing the command (e.g., `docker compose --compatibility up`).

Allow some time for the infrastructure to be ready.
How much will depend on your system, but after some time showing the error `"concurrent call in session"`, eventually the container logs will repeatedly show the following:

```shell
server_manager_1      | Received GetVersion
server_manager_1      | Received GetStatus
server_manager_1      |   default_rollups_id
server_manager_1      | Received GetSessionStatus for session default_rollups_id
server_manager_1      |   0
server_manager_1      | Received GetEpochStatus for session default_rollups_id epoch 0
```

To stop the containers, first end the process with `Ctrl + C`.
Then, remove the containers and associated volumes by executing:

```shell
$ docker-compose down -v
```

## Interacting with the application

With the infrastructure in place, you can interact with the application using a set of Hardhat tasks.

First, go to a separate terminal window, switch to the `order-book/contracts` directory, and run `yarn`:

```shell
$ cd order-book/contracts/
$ yarn
```

Then, send an input as follows:

```shell
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"test"}'
```

The input will have been accepted when you receive a response similar to the following one:

````shell
Added input '{"resource":"test"}' to epoch '0' (index: '0', timestamp: 1650886109, signer: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266, tx: 0x6a07b324d4bad477f82fd6db85d8440520a657cc674f0048217817d7188370ed)```

In order to verify the notices generated by your inputs, run the command:

```shell
$ yarn hardhat --network localhost order-book:getNotices --epoch 0
````

The response should be something like this:

```shell
{"session_id":"default_rollups_id","epoch_index":"0","input_index":"0","notice_index":"0","payload":"7b22737461747573223a207b2273756363657373223a20747275652c20226d657373616765223a20227465737420696e707574207265636569766564227d7d"}
```

To retrieve notices interpreting the payload as a UTF-8 string, you can use the `--payload string` option:

```shell
$ yarn hardhat --network localhost order-book:getNotices --epoch 0 --payload string
{"session_id":"default_rollups_id","epoch_index":"0","input_index":"0","notice_index":"0","payload":"{\"status\": {\"success\": true, \"message\": \"test input received\"}}"
```

Finally, note that you can check the available options for all Hardhat tasks using the `--help` switch:

```shell
$ yarn hardhat --help
```

## Input format

The input for the application should be in the following structure:

```json
{
  "resource": "order",
  "action": "create",
  "data": {
    "unit_price": 8212,
    "amount": 2,
    "symbol": "ETH",
    "closing_time": 1650616219,
    "timestamp": 1650537001
  }
}
```

- `unit_price` is the price you want to exchange the asset at. If it's greater than 0 then you are buying (creating a bid) if it's less than 0 then you are selling (creating an ask)
- `amount` is the amount of the asset you want to exchange
- `symbol` is the symbol of the asset
- `closing_time` is the time your offer times out. If set to `0` it never times out
- `timestamp` is the current timestamp

All assets are traded in CTSI so the price should be given in CTSI.

### Example inputs

```shell
# Create a new buy order
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"create","data":{"unit_price":8212,"amount":2,"symbol":"ETH","closing_time":1650616219,"timestamp":1650537001}}'

# Create a new sell order
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"create","data":{"unit_price":8217,"amount":-21,"symbol":"ETH","closing_time":1650616219,"timestamp":1650537001}}'

# Get your orders
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"get"}'

# Delete an order
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"delete","data":{"id":1}}'

# Get all orders for a product
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"get_book","data":{"symbol":"ETH"}}'

# Get all bids for a product
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"get_bids","data":{"symbol":"ETH"}}'

# Get all offers for a product
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"get_offers","data":{"symbol":"ETH"}}'

# Get the highest bid for a product
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"get_bid","data":{"symbol":"ETH"}}'

# Get the lowest offer for a product
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"get_offer","data":{"symbol":"ETH"}}'

# Get the bid-offer spread for a product
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"get_spread","data":{"symbol":"ETH"}}'

# Get market data (highest bid, lowest offer and associated amount, bid-offer spread, mid-price) for a product
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"order","action":"get_market","data":{"symbol":"ETH"}}'

# Get all supported products
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"product","action":"get"}'

# Add new product
$ yarn hardhat --network localhost order-book:addInput --input '{"resource":"product","action":"add","data":{"symbol":"DMC","name":"Dummycoin"}}'
```

## Advancing time

To advance time, in order to simulate the passing of epochs, run:

```shell
$ yarn hardhat --network localhost util:advanceTime --seconds 864010
```

## Running the environment in host mode

When developing an application, it is often important to easily test and debug it. For that matter, it is possible to run the Cartesi Rollups environment in [host mode](../README.md#host-mode), so that the DApp's back-end can be executed directly on the host machine, allowing it to be debugged using regular development tools such as an IDE.

The first step is to run the environment in host mode using the following command:

```shell
$ docker-compose -f docker-compose.yml -f docker-compose-host.yml up --build
```

The next step is to run the order-book server in your machine. The application is written in Python, so you need to have `python3` installed.

In order to start the order-book server, run the following commands in a dedicated terminal:

```shell
$ cd order-book/server/
$ python3 -m venv .env
$ . .env/bin/activate
$ pip install -r requirements.txt
$ HTTP_DISPATCHER_URL="http://127.0.0.1:5004" gunicorn --reload --workers 1 --bind 0.0.0.0:5003 order-book:app
```

This will run the order-book server on port `5003` and send the corresponding notices to port `5004`. The server will also automatically reload if there is a change in the source code, enabling fast development iterations.

The final command, which effectively starts the server, can also be configured in an IDE to allow interactive debugging using features like breakpoints. In that case, it may be interesting to add the parameter `--timeout 0` to gunicorn, to avoid having it time out when the debugger stops at a breakpoint.

After the server successfully starts, it should print an output like the following:

```
[2022-01-21 12:38:23,971] INFO in order-book: HTTP dispatcher url is http://127.0.0.1:5004
[2022-01-21 12:38:23 -0500] [79032] [INFO] Starting gunicorn 19.9.0
[2022-01-21 12:38:23 -0500] [79032] [INFO] Listening at: http://0.0.0.0:5003 (79032)
[2022-01-21 12:38:23 -0500] [79032] [INFO] Using worker: sync
[2022-01-21 12:38:23 -0500] [79035] [INFO] Booting worker with pid: 79035
```

After that, you can interact with the application normally [as explained above](#interacting-with-the-application).

When you add an input, you should see it being processed by the order-book server as follows:

```shell
[2022-01-21 15:58:39,555] INFO in order-book: Received advance request body {'metadata': {'msg_sender': '0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266', 'epoch_index': 0, 'input_index': 0, 'block_number': 11, 'time_stamp': 1642791522}, 'payload': '0x636172746573690d0a'}
[2022-01-21 15:58:39,556] INFO in order-book: Adding notice
[2022-01-21 15:58:39,650] INFO in order-book: Received notice status 201 body b'{"index":0}'
[2022-01-21 15:58:39,651] INFO in order-book: Finishing
[2022-01-21 15:58:39,666] INFO in order-book: Received finish status 202
```

Finally, to stop the containers, removing any associated volumes, execute:

```shell
$ docker-compose -f docker-compose.yml -f docker-compose-host.yml down -v
```
